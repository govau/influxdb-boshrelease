#! /usr/bin/env bash

set -e -x

RUN_DIR=/var/vcap/sys/run/influxdb
LOG_DIR=/var/vcap/sys/log/influxdb
TMP_DIR=/var/vcap/sys/tmp/influxdb
STORE_DIR=/var/vcap/store/influxdb
mkdir -p ${RUN_DIR} ${LOG_DIR} ${TMP_DIR} ${STORE_DIR}
chown -R vcap:vcap ${RUN_DIR} ${LOG_DIR} ${TMP_DIR} ${STORE_DIR}

PIDFILE=${RUN_DIR}/influxdb.pid
touch $PIDFILE
chown -R vcap:vcap $PIDFILE

source /var/vcap/jobs/influxdb/bin/utils.sh

export PATH=/var/vcap/packages/influxdb:${PATH}

case $1 in
  start)
    pid_guard ${PIDFILE} "influxdb"
    echo $$ > ${PIDFILE}

    ulimit -n 65536

    exec influxd run \
      -config /var/vcap/jobs/influxdb/config/influxdb.conf \
      -pidfile $PIDFILE \
      >>  ${LOG_DIR}/influxdb.stdout.log \
      2>> ${LOG_DIR}/influxdb.stderr.log &

    sleep 2

    echo "Ensure user  <%= p('influxdb.user') %> exists" >>  ${LOG_DIR}/influxdb.stdout.log
    influx -ssl \
      -unsafeSsl \
      -username "<%= p('influxdb.user') %>" \
      -password "<%= p('influxdb.password') %>" \
      -execute "CREATE USER <%= p('influxdb.user') %> WITH PASSWORD '<%= p('influxdb.password') %>' WITH ALL PRIVILEGES" \
      >>  ${LOG_DIR}/influxdb.stdout.log \
      2>> ${LOG_DIR}/influxdb.stderr.log

    echo "Ensure database <%= p('influxdb.database') %> exists" >>  ${LOG_DIR}/influxdb.stdout.log
    influx -ssl \
      -unsafeSsl \
      -username "<%= p('influxdb.user') %>" \
      -password "<%= p('influxdb.password') %>" \
      -execute "CREATE DATABASE <%= p('influxdb.database') %>" \
      >>  ${LOG_DIR}/influxdb.stdout.log \
      2>> ${LOG_DIR}/influxdb.stderr.log
  ;;

  stop)
    kill_and_wait ${PIDFILE} 60
    ;;

  *)
    echo "Usage: $0 {start|stop}"
    exit 1
  ;;

esac
exit 0
